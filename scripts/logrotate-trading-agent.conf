# Logrotate configuration for AI Crypto Trading Agent on Intel NUC
# This configuration ensures proper log rotation and archival for production deployment

# Main application logs
/opt/trading-agent/logs/application-*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 trading trading
    postrotate
        # Send SIGUSR1 to reload log files if the process is running
        if [ -f /var/run/trading-agent.pid ]; then
            kill -USR1 `cat /var/run/trading-agent.pid` 2>/dev/null || true
        fi
    endscript
}

# Error logs - keep longer for debugging
/opt/trading-agent/logs/error-*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 0640 trading trading
    postrotate
        if [ -f /var/run/trading-agent.pid ]; then
            kill -USR1 `cat /var/run/trading-agent.pid` 2>/dev/null || true
        fi
    endscript
}

# Trading logs - critical for financial records
/opt/trading-agent/logs/trading/trading-*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 0640 trading trading
    # Archive old trading logs to secure location
    postrotate
        # Create backup of trading logs
        if [ -d /opt/trading-agent/backups/logs ]; then
            find /opt/trading-agent/logs/trading -name "trading-*.log.*.gz" -mtime +7 -exec cp {} /opt/trading-agent/backups/logs/ \;
        fi
        if [ -f /var/run/trading-agent.pid ]; then
            kill -USR1 `cat /var/run/trading-agent.pid` 2>/dev/null || true
        fi
    endscript
}

# Audit logs - keep for compliance (1 year)
/opt/trading-agent/logs/audit/audit-*.log {
    daily
    rotate 365
    compress
    delaycompress
    missingok
    notifempty
    create 0600 trading trading
    # Audit logs require special handling
    postrotate
        # Create secure backup of audit logs
        if [ -d /opt/trading-agent/backups/audit ]; then
            find /opt/trading-agent/logs/audit -name "audit-*.log.*.gz" -mtime +1 -exec cp {} /opt/trading-agent/backups/audit/ \;
        fi
        # Generate audit log integrity hash
        if [ -f /opt/trading-agent/scripts/generate-audit-hash.sh ]; then
            /opt/trading-agent/scripts/generate-audit-hash.sh
        fi
    endscript
}

# Security logs - keep for incident investigation (1 year)
/opt/trading-agent/logs/security/security-*.log {
    daily
    rotate 365
    compress
    delaycompress
    missingok
    notifempty
    create 0600 trading trading
    postrotate
        # Create secure backup of security logs
        if [ -d /opt/trading-agent/backups/security ]; then
            find /opt/trading-agent/logs/security -name "security-*.log.*.gz" -mtime +1 -exec cp {} /opt/trading-agent/backups/security/ \;
        fi
    endscript
}

# System performance logs
/opt/trading-agent/logs/performance-*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 trading trading
}

# SSH tunnel logs
/opt/trading-agent/logs/tunnel-*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 0640 trading trading
}

# Dashboard logs
/opt/trading-agent/logs/dashboard-*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 0640 trading trading
}