bdff00fa2f701aeb9b6f08f9fe246242
"use strict";
/**
 * =============================================================================
 * AI CRYPTO TRADING AGENT - SECURE CREDENTIAL MANAGEMENT SERVICE
 * =============================================================================
 *
 * This service manages all sensitive credentials for the AI crypto trading
 * agent, including API keys, secrets, and authentication tokens. It provides
 * secure storage, retrieval, and rotation of credentials with audit logging.
 *
 * CRITICAL SECURITY NOTICE:
 * This service protects credentials that control access to trading capital.
 * Any compromise could result in total loss of funds. All operations are
 * logged and monitored for security analysis.
 *
 * @author AI Crypto Trading System
 * @version 1.0.0
 * @license PROPRIETARY
 * =============================================================================
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.credentialManager = exports.CredentialManager = exports.CredentialType = void 0;
const encryption_service_1 = require("@/security/encryption-service");
const key_manager_1 = require("@/security/key-manager");
const logger_1 = require("@/core/logging/logger");
/**
 * Enumeration of credential types
 */
var CredentialType;
(function (CredentialType) {
    CredentialType["API_KEY"] = "api_key";
    CredentialType["API_SECRET"] = "api_secret";
    CredentialType["API_PASSPHRASE"] = "api_passphrase";
    CredentialType["JWT_SECRET"] = "jwt_secret";
    CredentialType["SESSION_SECRET"] = "session_secret";
    CredentialType["DATABASE_PASSWORD"] = "database_password";
    CredentialType["ENCRYPTION_KEY"] = "encryption_key";
    CredentialType["WEBHOOK_SECRET"] = "webhook_secret";
})(CredentialType || (exports.CredentialType = CredentialType = {}));
/**
 * Secure credential management service
 * Handles all sensitive credential operations with encryption and auditing
 */
class CredentialManager {
    /** In-memory credential cache */
    credentialCache = new Map();
    /** Cache TTL in milliseconds (5 minutes) */
    static CACHE_TTL = 5 * 60 * 1000;
    constructor() {
        // Initialize credential encryption key
        this.initializeCredentialKey();
        // Start cache cleanup
        this.startCacheCleanup();
    }
    /**
     * Initialize or retrieve credential encryption key
     */
    async initializeCredentialKey() {
        try {
            // Try to get existing credential key
            const existingKeys = await key_manager_1.keyManager.listKeys(key_manager_1.KeyType.API_ENCRYPTION);
            if (existingKeys.length === 0) {
                // Generate new credential encryption key
                await key_manager_1.keyManager.generateKey(key_manager_1.KeyType.API_ENCRYPTION, 'API credential encryption', 256);
                logger_1.logger.info('üîê New credential encryption key generated');
            }
        }
        catch (error) {
            logger_1.logger.error('‚ùå Failed to initialize credential key:', error);
            throw new Error('Credential manager initialization failed');
        }
    } /**
  
     * Store credentials securely
     * Encrypts and stores credentials with metadata
     *
     * @param service - Service name (e.g., 'gate.io')
     * @param type - Type of credential
     * @param data - Credential data to store
     * @returns Promise<string> Credential ID
     */
    async storeCredential(service, type, data) {
        try {
            // Generate unique credential ID
            const credentialId = this.generateCredentialId(service, type);
            // Get credential encryption key
            const credentialKeys = await key_manager_1.keyManager.listKeys(key_manager_1.KeyType.API_ENCRYPTION);
            const activeKey = credentialKeys.find(k => k.status === 'active');
            if (!activeKey) {
                throw new Error('No active credential encryption key found');
            }
            // Encrypt credential data
            const encryptedData = await encryption_service_1.encryptionService.encryptCredentials(data);
            // Create credential entry
            const credentialEntry = {
                credentialId,
                service,
                type,
                encryptedData,
                createdAt: new Date(),
                isActive: true,
                usageCount: 0
            };
            // Store credential (implementation would use secure database)
            await this.persistCredential(credentialEntry);
            // Log credential storage (without sensitive data)
            logger_1.logger.security('CREDENTIAL_STORED', 'Credential stored securely', {
                credentialId,
                service,
                type,
                classification: 'RESTRICTED'
            });
            // Audit log
            logger_1.logger.audit({
                auditId: `cred_store_${credentialId}`,
                eventType: 'CREDENTIAL_STORAGE',
                actor: 'SYSTEM',
                resource: `CREDENTIAL:${credentialId}`,
                action: 'STORE',
                result: 'SUCCESS',
                timestamp: new Date(),
                auditData: { service, type }
            });
            return credentialId;
        }
        catch (error) {
            logger_1.logger.error('‚ùå Failed to store credential:', error);
            throw new Error('Credential storage failed');
        }
    }
    /**
     * Retrieve credentials securely
     * Decrypts and returns credential data
     *
     * @param credentialId - Credential identifier
     * @returns Promise<any> Decrypted credential data
     */
    async getCredential(credentialId) {
        try {
            // Check cache first
            const cached = this.credentialCache.get(credentialId);
            if (cached && cached.expiresAt > Date.now()) {
                return cached.data;
            }
            // Load credential from storage
            const credentialEntry = await this.loadCredential(credentialId);
            if (!credentialEntry || !credentialEntry.isActive) {
                throw new Error('Credential not found or inactive');
            }
            // Check expiration
            if (credentialEntry.expiresAt && credentialEntry.expiresAt < new Date()) {
                throw new Error('Credential has expired');
            }
            // Decrypt credential data
            const decryptedData = await encryption_service_1.encryptionService.decryptCredentials(credentialEntry.encryptedData);
            // Update usage statistics
            credentialEntry.usageCount++;
            credentialEntry.lastAccessed = new Date();
            await this.updateCredential(credentialEntry);
            // Cache for performance
            this.credentialCache.set(credentialId, {
                data: decryptedData,
                expiresAt: Date.now() + CredentialManager.CACHE_TTL
            });
            return decryptedData;
        }
        catch (error) {
            logger_1.logger.error('‚ùå Failed to retrieve credential:', error);
            throw new Error('Credential retrieval failed');
        }
    }
    /**
     * Get Gate.io API credentials
     * Convenience method for retrieving trading API credentials
     *
     * @returns Promise<GateIOCredentials> Gate.io API credentials
     */
    async getGateIOCredentials() {
        try {
            // Get credentials from environment or storage
            const apiKey = process.env.GATE_IO_API_KEY;
            const apiSecret = process.env.GATE_IO_API_SECRET;
            const passphrase = process.env.GATE_IO_API_PASSPHRASE;
            if (!apiKey || !apiSecret || !passphrase) {
                throw new Error('Gate.io API credentials not configured');
            }
            // Log credential access (without sensitive data)
            logger_1.logger.security('CREDENTIAL_ACCESSED', 'Gate.io credentials accessed', {
                service: 'gate.io',
                classification: 'RESTRICTED'
            });
            return {
                apiKey,
                apiSecret,
                passphrase
            };
        }
        catch (error) {
            logger_1.logger.error('‚ùå Failed to get Gate.io credentials:', error);
            throw new Error('Gate.io credential retrieval failed');
        }
    }
    /**
     * Rotate credentials
     * Generates new credentials and marks old ones as deprecated
     *
     * @param credentialId - Credential to rotate
     * @returns Promise<string> New credential ID
     */
    async rotateCredential(credentialId) {
        try {
            // Load current credential
            const currentCredential = await this.loadCredential(credentialId);
            if (!currentCredential) {
                throw new Error('Credential not found');
            }
            // Mark current credential as deprecated
            currentCredential.isActive = false;
            await this.updateCredential(currentCredential);
            // Remove from cache
            this.credentialCache.delete(credentialId);
            // Log credential rotation
            logger_1.logger.security('CREDENTIAL_ROTATED', 'Credential rotated', {
                oldCredentialId: credentialId,
                service: currentCredential.service,
                type: currentCredential.type,
                classification: 'RESTRICTED'
            });
            // Note: New credential would need to be provided by external system
            // This method marks the old one as inactive
            return credentialId; // Would return new credential ID in full implementation
        }
        catch (error) {
            logger_1.logger.error('‚ùå Failed to rotate credential:', error);
            throw new Error('Credential rotation failed');
        }
    }
    /**
     * Generate unique credential ID
     * Creates identifier for credential storage
     *
     * @param service - Service name
     * @param type - Credential type
     * @returns string Unique credential ID
     */
    generateCredentialId(service, type) {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substring(2);
        return `${service}_${type}_${timestamp}_${random}`;
    }
    /**
     * Persist credential to secure storage
     * Stores credential entry securely
     *
     * @param credentialEntry - Credential entry to store
     */
    async persistCredential(credentialEntry) {
        // Implementation would store in secure database
        // For now, this is a placeholder
        logger_1.logger.debug('Credential persisted to secure storage', {
            credentialId: credentialEntry.credentialId
        });
    }
    /**
     * Load credential from secure storage
     * Retrieves credential entry from storage
     *
     * @param credentialId - Credential identifier
     * @returns Promise<CredentialEntry | null> Credential entry or null
     */
    async loadCredential(credentialId) {
        // Implementation would load from secure database
        // For now, this is a placeholder
        return null;
    }
    /**
     * Update credential in storage
     * Updates credential entry in secure storage
     *
     * @param credentialEntry - Updated credential entry
     */
    async updateCredential(credentialEntry) {
        // Implementation would update in secure database
        // For now, this is a placeholder
        logger_1.logger.debug('Credential updated in secure storage', {
            credentialId: credentialEntry.credentialId
        });
    }
    /**
     * Start cache cleanup process
     * Removes expired entries from credential cache
     */
    startCacheCleanup() {
        setInterval(() => {
            const now = Date.now();
            for (const [key, value] of this.credentialCache.entries()) {
                if (value.expiresAt <= now) {
                    this.credentialCache.delete(key);
                }
            }
        }, 60000); // Clean up every minute
    }
    /**
     * Get credential manager status
     * Returns current status for monitoring
     *
     * @returns Object containing status information
     */
    getStatus() {
        return {
            cacheSize: this.credentialCache.size,
            timestamp: Date.now()
        };
    }
}
exports.CredentialManager = CredentialManager;
// Create and export singleton instance
exports.credentialManager = new CredentialManager();
// =============================================================================
// CREDENTIAL SECURITY NOTES
// =============================================================================
// 1. All credentials are encrypted before storage
// 2. Credentials are cached temporarily for performance
// 3. All credential access is logged and audited
// 4. Expired credentials are automatically rejected
// 5. Credential rotation invalidates old credentials
// 6. Cache is automatically cleaned of expired entries
// 7. Never log actual credential values
// 8. Use environment variables for initial credential loading
// =============================================================================
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxOaWNrXFxEZXNrdG9wXFxTbW9vdGhTYWlsXFxzcmNcXHNlY3VyaXR5XFxjcmVkZW50aWFsLW1hbmFnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FrQkc7OztBQUVILHNFQUFpRjtBQUNqRix3REFBNkQ7QUFDN0Qsa0RBQStDO0FBMkIvQzs7R0FFRztBQUNILElBQVksY0FTWDtBQVRELFdBQVksY0FBYztJQUN4QixxQ0FBbUIsQ0FBQTtJQUNuQiwyQ0FBeUIsQ0FBQTtJQUN6QixtREFBaUMsQ0FBQTtJQUNqQywyQ0FBeUIsQ0FBQTtJQUN6QixtREFBaUMsQ0FBQTtJQUNqQyx5REFBdUMsQ0FBQTtJQUN2QyxtREFBaUMsQ0FBQTtJQUNqQyxtREFBaUMsQ0FBQTtBQUNuQyxDQUFDLEVBVFcsY0FBYyw4QkFBZCxjQUFjLFFBU3pCO0FBV0Q7OztHQUdHO0FBQ0gsTUFBYSxpQkFBaUI7SUFDNUIsaUNBQWlDO0lBQ3pCLGVBQWUsR0FBa0QsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUVuRiw0Q0FBNEM7SUFDcEMsTUFBTSxDQUFVLFNBQVMsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztJQUVsRDtRQUNFLHVDQUF1QztRQUN2QyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUUvQixzQkFBc0I7UUFDdEIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVEOztPQUVHO0lBQ0ssS0FBSyxDQUFDLHVCQUF1QjtRQUNuQyxJQUFJLENBQUM7WUFDSCxxQ0FBcUM7WUFDckMsTUFBTSxZQUFZLEdBQUcsTUFBTSx3QkFBVSxDQUFDLFFBQVEsQ0FBQyxxQkFBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBRXZFLElBQUksWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDOUIseUNBQXlDO2dCQUN6QyxNQUFNLHdCQUFVLENBQUMsV0FBVyxDQUMxQixxQkFBTyxDQUFDLGNBQWMsRUFDdEIsMkJB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QUksaUJBQWlCLEVBQUUsQ0FBQztBQUV6RCxnRkFBZ0Y7QUFDaEYsNEJBQTRCO0FBQzVCLGdGQUFnRjtBQUNoRixrREFBa0Q7QUFDbEQsd0RBQXdEO0FBQ3hELGlEQUFpRDtBQUNqRCxvREFBb0Q7QUFDcEQscURBQXFEO0FBQ3JELHVEQUF1RDtBQUN2RCx3Q0FBd0M7QUFDeEMsOERBQThEO0FBQzlELGdGQUFnRiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXE5pY2tcXERlc2t0b3BcXFNtb290aFNhaWxcXHNyY1xcc2VjdXJpdHlcXGNyZWRlbnRpYWwtbWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICogQUkgQ1JZUFRPIFRSQURJTkcgQUdFTlQgLSBTRUNVUkUgQ1JFREVOVElBTCBNQU5BR0VNRU5UIFNFUlZJQ0VcclxuICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICogXHJcbiAqIFRoaXMgc2VydmljZSBtYW5hZ2VzIGFsbCBzZW5zaXRpdmUgY3JlZGVudGlhbHMgZm9yIHRoZSBBSSBjcnlwdG8gdHJhZGluZ1xyXG4gKiBhZ2VudCwgaW5jbHVkaW5nIEFQSSBrZXlzLCBzZWNyZXRzLCBhbmQgYXV0aGVudGljYXRpb24gdG9rZW5zLiBJdCBwcm92aWRlc1xyXG4gKiBzZWN1cmUgc3RvcmFnZSwgcmV0cmlldmFsLCBhbmQgcm90YXRpb24gb2YgY3JlZGVudGlhbHMgd2l0aCBhdWRpdCBsb2dnaW5nLlxyXG4gKiBcclxuICogQ1JJVElDQUwgU0VDVVJJVFkgTk9USUNFOlxyXG4gKiBUaGlzIHNlcnZpY2UgcHJvdGVjdHMgY3JlZGVudGlhbHMgdGhhdCBjb250cm9sIGFjY2VzcyB0byB0cmFkaW5nIGNhcGl0YWwuXHJcbiAqIEFueSBjb21wcm9taXNlIGNvdWxkIHJlc3VsdCBpbiB0b3RhbCBsb3NzIG9mIGZ1bmRzLiBBbGwgb3BlcmF0aW9ucyBhcmVcclxuICogbG9nZ2VkIGFuZCBtb25pdG9yZWQgZm9yIHNlY3VyaXR5IGFuYWx5c2lzLlxyXG4gKiBcclxuICogQGF1dGhvciBBSSBDcnlwdG8gVHJhZGluZyBTeXN0ZW1cclxuICogQHZlcnNpb24gMS4wLjBcclxuICogQGxpY2Vuc2UgUFJPUFJJRVRBUllcclxuICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICovXHJcblxyXG5pbXBvcnQgeyBlbmNyeXB0aW9uU2VydmljZSwgRW5jcnlwdGVkRGF0YSB9IGZyb20gJ0Avc2VjdXJpdHkvZW5jcnlwdGlvbi1zZXJ2aWNlJztcclxuaW1wb3J0IHsga2V5TWFuYWdlciwgS2V5VHlwZSB9IGZyb20gJ0Avc2VjdXJpdHkva2V5LW1hbmFnZXInO1xyXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdAL2NvcmUvbG9nZ2luZy9sb2dnZXInO1xyXG5cclxuLyoqXHJcbiAqIEludGVyZmFjZSBmb3IgY3JlZGVudGlhbCBlbnRyeVxyXG4gKiBEZWZpbmVzIHN0cnVjdHVyZSBmb3Igc3RvcmVkIGNyZWRlbnRpYWxzXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIENyZWRlbnRpYWxFbnRyeSB7XHJcbiAgLyoqIFVuaXF1ZSBjcmVkZW50aWFsIGlkZW50aWZpZXIgKi9cclxuICBjcmVkZW50aWFsSWQ6IHN0cmluZztcclxuICAvKiogU2VydmljZSBvciBzeXN0ZW0gdGhlIGNyZWRlbnRpYWwgaXMgZm9yICovXHJcbiAgc2VydmljZTogc3RyaW5nO1xyXG4gIC8qKiBUeXBlIG9mIGNyZWRlbnRpYWwgKi9cclxuICB0eXBlOiBDcmVkZW50aWFsVHlwZTtcclxuICAvKiogRW5jcnlwdGVkIGNyZWRlbnRpYWwgZGF0YSAqL1xyXG4gIGVuY3J5cHRlZERhdGE6IEVuY3J5cHRlZERhdGE7XHJcbiAgLyoqIENyZWF0aW9uIHRpbWVzdGFtcCAqL1xyXG4gIGNyZWF0ZWRBdDogRGF0ZTtcclxuICAvKiogTGFzdCBhY2Nlc3MgdGltZXN0YW1wICovXHJcbiAgbGFzdEFjY2Vzc2VkPzogRGF0ZTtcclxuICAvKiogRXhwaXJhdGlvbiB0aW1lc3RhbXAgKi9cclxuICBleHBpcmVzQXQ/OiBEYXRlO1xyXG4gIC8qKiBXaGV0aGVyIGNyZWRlbnRpYWwgaXMgYWN0aXZlICovXHJcbiAgaXNBY3RpdmU6IGJvb2xlYW47XHJcbiAgLyoqIFVzYWdlIGNvdW50ZXIgKi9cclxuICB1c2FnZUNvdW50OiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBFbnVtZXJhdGlvbiBvZiBjcmVkZW50aWFsIHR5cGVzXHJcbiAqL1xyXG5leHBvcnQgZW51bSBDcmVkZW50aWFsVHlwZSB7XHJcbiAgQVBJX0tFWSA9ICdhcGlfa2V5JyxcclxuICBBUElfU0VDUkVUID0gJ2FwaV9zZWNyZXQnLFxyXG4gIEFQSV9QQVNTUEhSQVNFID0gJ2FwaV9wYXNzcGhyYXNlJyxcclxuICBKV1RfU0VDUkVUID0gJ2p3dF9zZWNyZXQnLFxyXG4gIFNFU1NJT05fU0VDUkVUID0gJ3Nlc3Npb25fc2VjcmV0JyxcclxuICBEQVRBQkFTRV9QQVNTV09SRCA9ICdkYXRhYmFzZV9wYXNzd29yZCcsXHJcbiAgRU5DUllQVElPTl9LRVkgPSAnZW5jcnlwdGlvbl9rZXknLFxyXG4gIFdFQkhPT0tfU0VDUkVUID0gJ3dlYmhvb2tfc2VjcmV0J1xyXG59XHJcblxyXG4vKipcclxuICogSW50ZXJmYWNlIGZvciBHYXRlLmlvIEFQSSBjcmVkZW50aWFsc1xyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBHYXRlSU9DcmVkZW50aWFscyB7XHJcbiAgYXBpS2V5OiBzdHJpbmc7XHJcbiAgYXBpU2VjcmV0OiBzdHJpbmc7XHJcbiAgcGFzc3BocmFzZTogc3RyaW5nO1xyXG59XHJcblxyXG4vKipcclxuICogU2VjdXJlIGNyZWRlbnRpYWwgbWFuYWdlbWVudCBzZXJ2aWNlXHJcbiAqIEhhbmRsZXMgYWxsIHNlbnNpdGl2ZSBjcmVkZW50aWFsIG9wZXJhdGlvbnMgd2l0aCBlbmNyeXB0aW9uIGFuZCBhdWRpdGluZ1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIENyZWRlbnRpYWxNYW5hZ2VyIHtcclxuICAvKiogSW4tbWVtb3J5IGNyZWRlbnRpYWwgY2FjaGUgKi9cclxuICBwcml2YXRlIGNyZWRlbnRpYWxDYWNoZTogTWFwPHN0cmluZywgeyBkYXRhOiBhbnk7IGV4cGlyZXNBdDogbnVtYmVyIH0+ID0gbmV3IE1hcCgpO1xyXG4gIFxyXG4gIC8qKiBDYWNoZSBUVEwgaW4gbWlsbGlzZWNvbmRzICg1IG1pbnV0ZXMpICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgQ0FDSEVfVFRMID0gNSAqIDYwICogMTAwMDtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAvLyBJbml0aWFsaXplIGNyZWRlbnRpYWwgZW5jcnlwdGlvbiBrZXlcclxuICAgIHRoaXMuaW5pdGlhbGl6ZUNyZWRlbnRpYWxLZXkoKTtcclxuICAgIFxyXG4gICAgLy8gU3RhcnQgY2FjaGUgY2xlYW51cFxyXG4gICAgdGhpcy5zdGFydENhY2hlQ2xlYW51cCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSW5pdGlhbGl6ZSBvciByZXRyaWV2ZSBjcmVkZW50aWFsIGVuY3J5cHRpb24ga2V5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhc3luYyBpbml0aWFsaXplQ3JlZGVudGlhbEtleSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIFRyeSB0byBnZXQgZXhpc3RpbmcgY3JlZGVudGlhbCBrZXlcclxuICAgICAgY29uc3QgZXhpc3RpbmdLZXlzID0gYXdhaXQga2V5TWFuYWdlci5saXN0S2V5cyhLZXlUeXBlLkFQSV9FTkNSWVBUSU9OKTtcclxuICAgICAgXHJcbiAgICAgIGlmIChleGlzdGluZ0tleXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgLy8gR2VuZXJhdGUgbmV3IGNyZWRlbnRpYWwgZW5jcnlwdGlvbiBrZXlcclxuICAgICAgICBhd2FpdCBrZXlNYW5hZ2VyLmdlbmVyYXRlS2V5KFxyXG4gICAgICAgICAgS2V5VHlwZS5BUElfRU5DUllQVElPTixcclxuICAgICAgICAgICdBUEkgY3JlZGVudGlhbCBlbmNyeXB0aW9uJyxcclxuICAgICAgICAgIDI1NlxyXG4gICAgICAgICk7XHJcbiAgICAgICAgbG9nZ2VyLmluZm8oJ/CflJAgTmV3IGNyZWRlbnRpYWwgZW5jcnlwdGlvbiBrZXkgZ2VuZXJhdGVkJyk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoJ+KdjCBGYWlsZWQgdG8gaW5pdGlhbGl6ZSBjcmVkZW50aWFsIGtleTonLCBlcnJvcik7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ3JlZGVudGlhbCBtYW5hZ2VyIGluaXRpYWxpemF0aW9uIGZhaWxlZCcpO1xyXG4gICAgfVxyXG4gIH0gIC8qKlxyXG5cclxuICAgKiBTdG9yZSBjcmVkZW50aWFscyBzZWN1cmVseVxyXG4gICAqIEVuY3J5cHRzIGFuZCBzdG9yZXMgY3JlZGVudGlhbHMgd2l0aCBtZXRhZGF0YVxyXG4gICAqIFxyXG4gICAqIEBwYXJhbSBzZXJ2aWNlIC0gU2VydmljZSBuYW1lIChlLmcuLCAnZ2F0ZS5pbycpXHJcbiAgICogQHBhcmFtIHR5cGUgLSBUeXBlIG9mIGNyZWRlbnRpYWxcclxuICAgKiBAcGFyYW0gZGF0YSAtIENyZWRlbnRpYWwgZGF0YSB0byBzdG9yZVxyXG4gICAqIEByZXR1cm5zIFByb21pc2U8c3RyaW5nPiBDcmVkZW50aWFsIElEXHJcbiAgICovXHJcbiAgcHVibGljIGFzeW5jIHN0b3JlQ3JlZGVudGlhbChcclxuICAgIHNlcnZpY2U6IHN0cmluZyxcclxuICAgIHR5cGU6IENyZWRlbnRpYWxUeXBlLFxyXG4gICAgZGF0YTogYW55XHJcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIEdlbmVyYXRlIHVuaXF1ZSBjcmVkZW50aWFsIElEXHJcbiAgICAgIGNvbnN0IGNyZWRlbnRpYWxJZCA9IHRoaXMuZ2VuZXJhdGVDcmVkZW50aWFsSWQoc2VydmljZSwgdHlwZSk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBHZXQgY3JlZGVudGlhbCBlbmNyeXB0aW9uIGtleVxyXG4gICAgICBjb25zdCBjcmVkZW50aWFsS2V5cyA9IGF3YWl0IGtleU1hbmFnZXIubGlzdEtleXMoS2V5VHlwZS5BUElfRU5DUllQVElPTik7XHJcbiAgICAgIGNvbnN0IGFjdGl2ZUtleSA9IGNyZWRlbnRpYWxLZXlzLmZpbmQoayA9PiBrLnN0YXR1cyA9PT0gJ2FjdGl2ZScpO1xyXG4gICAgICBcclxuICAgICAgaWYgKCFhY3RpdmVLZXkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGFjdGl2ZSBjcmVkZW50aWFsIGVuY3J5cHRpb24ga2V5IGZvdW5kJyk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIC8vIEVuY3J5cHQgY3JlZGVudGlhbCBkYXRhXHJcbiAgICAgIGNvbnN0IGVuY3J5cHRlZERhdGEgPSBhd2FpdCBlbmNyeXB0aW9uU2VydmljZS5lbmNyeXB0Q3JlZGVudGlhbHMoZGF0YSk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBDcmVhdGUgY3JlZGVudGlhbCBlbnRyeVxyXG4gICAgICBjb25zdCBjcmVkZW50aWFsRW50cnk6IENyZWRlbnRpYWxFbnRyeSA9IHtcclxuICAgICAgICBjcmVkZW50aWFsSWQsXHJcbiAgICAgICAgc2VydmljZSxcclxuICAgICAgICB0eXBlLFxyXG4gICAgICAgIGVuY3J5cHRlZERhdGEsXHJcbiAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgIGlzQWN0aXZlOiB0cnVlLFxyXG4gICAgICAgIHVzYWdlQ291bnQ6IDBcclxuICAgICAgfTtcclxuICAgICAgXHJcbiAgICAgIC8vIFN0b3JlIGNyZWRlbnRpYWwgKGltcGxlbWVudGF0aW9uIHdvdWxkIHVzZSBzZWN1cmUgZGF0YWJhc2UpXHJcbiAgICAgIGF3YWl0IHRoaXMucGVyc2lzdENyZWRlbnRpYWwoY3JlZGVudGlhbEVudHJ5KTtcclxuICAgICAgXHJcbiAgICAgIC8vIExvZyBjcmVkZW50aWFsIHN0b3JhZ2UgKHdpdGhvdXQgc2Vuc2l0aXZlIGRhdGEpXHJcbiAgICAgIGxvZ2dlci5zZWN1cml0eSgnQ1JFREVOVElBTF9TVE9SRUQnLCAnQ3JlZGVudGlhbCBzdG9yZWQgc2VjdXJlbHknLCB7XHJcbiAgICAgICAgY3JlZGVudGlhbElkLFxyXG4gICAgICAgIHNlcnZpY2UsXHJcbiAgICAgICAgdHlwZSxcclxuICAgICAgICBjbGFzc2lmaWNhdGlvbjogJ1JFU1RSSUNURUQnXHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgLy8gQXVkaXQgbG9nXHJcbiAgICAgIGxvZ2dlci5hdWRpdCh7XHJcbiAgICAgICAgYXVkaXRJZDogYGNyZWRfc3RvcmVfJHtjcmVkZW50aWFsSWR9YCxcclxuICAgICAgICBldmVudFR5cGU6ICdDUkVERU5USUFMX1NUT1JBR0UnLFxyXG4gICAgICAgIGFjdG9yOiAnU1lTVEVNJyxcclxuICAgICAgICByZXNvdXJjZTogYENSRURFTlRJQUw6JHtjcmVkZW50aWFsSWR9YCxcclxuICAgICAgICBhY3Rpb246ICdTVE9SRScsXHJcbiAgICAgICAgcmVzdWx0OiAnU1VDQ0VTUycsXHJcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgIGF1ZGl0RGF0YTogeyBzZXJ2aWNlLCB0eXBlIH1cclxuICAgICAgfSk7XHJcbiAgICAgIFxyXG4gICAgICByZXR1cm4gY3JlZGVudGlhbElkO1xyXG4gICAgICBcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcign4p2MIEZhaWxlZCB0byBzdG9yZSBjcmVkZW50aWFsOicsIGVycm9yKTtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDcmVkZW50aWFsIHN0b3JhZ2UgZmFpbGVkJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXRyaWV2ZSBjcmVkZW50aWFscyBzZWN1cmVseVxyXG4gICAqIERlY3J5cHRzIGFuZCByZXR1cm5zIGNyZWRlbnRpYWwgZGF0YVxyXG4gICAqIFxyXG4gICAqIEBwYXJhbSBjcmVkZW50aWFsSWQgLSBDcmVkZW50aWFsIGlkZW50aWZpZXJcclxuICAgKiBAcmV0dXJucyBQcm9taXNlPGFueT4gRGVjcnlwdGVkIGNyZWRlbnRpYWwgZGF0YVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhc3luYyBnZXRDcmVkZW50aWFsKGNyZWRlbnRpYWxJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIENoZWNrIGNhY2hlIGZpcnN0XHJcbiAgICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuY3JlZGVudGlhbENhY2hlLmdldChjcmVkZW50aWFsSWQpO1xyXG4gICAgICBpZiAoY2FjaGVkICYmIGNhY2hlZC5leHBpcmVzQXQgPiBEYXRlLm5vdygpKSB7XHJcbiAgICAgICAgcmV0dXJuIGNhY2hlZC5kYXRhO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBMb2FkIGNyZWRlbnRpYWwgZnJvbSBzdG9yYWdlXHJcbiAgICAgIGNvbnN0IGNyZWRlbnRpYWxFbnRyeSA9IGF3YWl0IHRoaXMubG9hZENyZWRlbnRpYWwoY3JlZGVudGlhbElkKTtcclxuICAgICAgaWYgKCFjcmVkZW50aWFsRW50cnkgfHwgIWNyZWRlbnRpYWxFbnRyeS5pc0FjdGl2ZSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ3JlZGVudGlhbCBub3QgZm91bmQgb3IgaW5hY3RpdmUnKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgLy8gQ2hlY2sgZXhwaXJhdGlvblxyXG4gICAgICBpZiAoY3JlZGVudGlhbEVudHJ5LmV4cGlyZXNBdCAmJiBjcmVkZW50aWFsRW50cnkuZXhwaXJlc0F0IDwgbmV3IERhdGUoKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ3JlZGVudGlhbCBoYXMgZXhwaXJlZCcpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBEZWNyeXB0IGNyZWRlbnRpYWwgZGF0YVxyXG4gICAgICBjb25zdCBkZWNyeXB0ZWREYXRhID0gYXdhaXQgZW5jcnlwdGlvblNlcnZpY2UuZGVjcnlwdENyZWRlbnRpYWxzKFxyXG4gICAgICAgIGNyZWRlbnRpYWxFbnRyeS5lbmNyeXB0ZWREYXRhXHJcbiAgICAgICk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBVcGRhdGUgdXNhZ2Ugc3RhdGlzdGljc1xyXG4gICAgICBjcmVkZW50aWFsRW50cnkudXNhZ2VDb3VudCsrO1xyXG4gICAgICBjcmVkZW50aWFsRW50cnkubGFzdEFjY2Vzc2VkID0gbmV3IERhdGUoKTtcclxuICAgICAgYXdhaXQgdGhpcy51cGRhdGVDcmVkZW50aWFsKGNyZWRlbnRpYWxFbnRyeSk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBDYWNoZSBmb3IgcGVyZm9ybWFuY2VcclxuICAgICAgdGhpcy5jcmVkZW50aWFsQ2FjaGUuc2V0KGNyZWRlbnRpYWxJZCwge1xyXG4gICAgICAgIGRhdGE6IGRlY3J5cHRlZERhdGEsXHJcbiAgICAgICAgZXhwaXJlc0F0OiBEYXRlLm5vdygpICsgQ3JlZGVudGlhbE1hbmFnZXIuQ0FDSEVfVFRMXHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgcmV0dXJuIGRlY3J5cHRlZERhdGE7XHJcbiAgICAgIFxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgbG9nZ2VyLmVycm9yKCfinYwgRmFpbGVkIHRvIHJldHJpZXZlIGNyZWRlbnRpYWw6JywgZXJyb3IpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NyZWRlbnRpYWwgcmV0cmlldmFsIGZhaWxlZCcpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IEdhdGUuaW8gQVBJIGNyZWRlbnRpYWxzXHJcbiAgICogQ29udmVuaWVuY2UgbWV0aG9kIGZvciByZXRyaWV2aW5nIHRyYWRpbmcgQVBJIGNyZWRlbnRpYWxzXHJcbiAgICogXHJcbiAgICogQHJldHVybnMgUHJvbWlzZTxHYXRlSU9DcmVkZW50aWFscz4gR2F0ZS5pbyBBUEkgY3JlZGVudGlhbHNcclxuICAgKi9cclxuICBwdWJsaWMgYXN5bmMgZ2V0R2F0ZUlPQ3JlZGVudGlhbHMoKTogUHJvbWlzZTxHYXRlSU9DcmVkZW50aWFscz4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gR2V0IGNyZWRlbnRpYWxzIGZyb20gZW52aXJvbm1lbnQgb3Igc3RvcmFnZVxyXG4gICAgICBjb25zdCBhcGlLZXkgPSBwcm9jZXNzLmVudi5HQVRFX0lPX0FQSV9LRVk7XHJcbiAgICAgIGNvbnN0IGFwaVNlY3JldCA9IHByb2Nlc3MuZW52LkdBVEVfSU9fQVBJX1NFQ1JFVDtcclxuICAgICAgY29uc3QgcGFzc3BocmFzZSA9IHByb2Nlc3MuZW52LkdBVEVfSU9fQVBJX1BBU1NQSFJBU0U7XHJcbiAgICAgIFxyXG4gICAgICBpZiAoIWFwaUtleSB8fCAhYXBpU2VjcmV0IHx8ICFwYXNzcGhyYXNlKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdHYXRlLmlvIEFQSSBjcmVkZW50aWFscyBub3QgY29uZmlndXJlZCcpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBMb2cgY3JlZGVudGlhbCBhY2Nlc3MgKHdpdGhvdXQgc2Vuc2l0aXZlIGRhdGEpXHJcbiAgICAgIGxvZ2dlci5zZWN1cml0eSgnQ1JFREVOVElBTF9BQ0NFU1NFRCcsICdHYXRlLmlvIGNyZWRlbnRpYWxzIGFjY2Vzc2VkJywge1xyXG4gICAgICAgIHNlcnZpY2U6ICdnYXRlLmlvJyxcclxuICAgICAgICBjbGFzc2lmaWNhdGlvbjogJ1JFU1RSSUNURUQnXHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBhcGlLZXksXHJcbiAgICAgICAgYXBpU2VjcmV0LFxyXG4gICAgICAgIHBhc3NwaHJhc2VcclxuICAgICAgfTtcclxuICAgICAgXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoJ+KdjCBGYWlsZWQgdG8gZ2V0IEdhdGUuaW8gY3JlZGVudGlhbHM6JywgZXJyb3IpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dhdGUuaW8gY3JlZGVudGlhbCByZXRyaWV2YWwgZmFpbGVkJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSb3RhdGUgY3JlZGVudGlhbHNcclxuICAgKiBHZW5lcmF0ZXMgbmV3IGNyZWRlbnRpYWxzIGFuZCBtYXJrcyBvbGQgb25lcyBhcyBkZXByZWNhdGVkXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGNyZWRlbnRpYWxJZCAtIENyZWRlbnRpYWwgdG8gcm90YXRlXHJcbiAgICogQHJldHVybnMgUHJvbWlzZTxzdHJpbmc+IE5ldyBjcmVkZW50aWFsIElEXHJcbiAgICovXHJcbiAgcHVibGljIGFzeW5jIHJvdGF0ZUNyZWRlbnRpYWwoY3JlZGVudGlhbElkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gTG9hZCBjdXJyZW50IGNyZWRlbnRpYWxcclxuICAgICAgY29uc3QgY3VycmVudENyZWRlbnRpYWwgPSBhd2FpdCB0aGlzLmxvYWRDcmVkZW50aWFsKGNyZWRlbnRpYWxJZCk7XHJcbiAgICAgIGlmICghY3VycmVudENyZWRlbnRpYWwpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NyZWRlbnRpYWwgbm90IGZvdW5kJyk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIC8vIE1hcmsgY3VycmVudCBjcmVkZW50aWFsIGFzIGRlcHJlY2F0ZWRcclxuICAgICAgY3VycmVudENyZWRlbnRpYWwuaXNBY3RpdmUgPSBmYWxzZTtcclxuICAgICAgYXdhaXQgdGhpcy51cGRhdGVDcmVkZW50aWFsKGN1cnJlbnRDcmVkZW50aWFsKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFJlbW92ZSBmcm9tIGNhY2hlXHJcbiAgICAgIHRoaXMuY3JlZGVudGlhbENhY2hlLmRlbGV0ZShjcmVkZW50aWFsSWQpO1xyXG4gICAgICBcclxuICAgICAgLy8gTG9nIGNyZWRlbnRpYWwgcm90YXRpb25cclxuICAgICAgbG9nZ2VyLnNlY3VyaXR5KCdDUkVERU5USUFMX1JPVEFURUQnLCAnQ3JlZGVudGlhbCByb3RhdGVkJywge1xyXG4gICAgICAgIG9sZENyZWRlbnRpYWxJZDogY3JlZGVudGlhbElkLFxyXG4gICAgICAgIHNlcnZpY2U6IGN1cnJlbnRDcmVkZW50aWFsLnNlcnZpY2UsXHJcbiAgICAgICAgdHlwZTogY3VycmVudENyZWRlbnRpYWwudHlwZSxcclxuICAgICAgICBjbGFzc2lmaWNhdGlvbjogJ1JFU1RSSUNURUQnXHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgLy8gTm90ZTogTmV3IGNyZWRlbnRpYWwgd291bGQgbmVlZCB0byBiZSBwcm92aWRlZCBieSBleHRlcm5hbCBzeXN0ZW1cclxuICAgICAgLy8gVGhpcyBtZXRob2QgbWFya3MgdGhlIG9sZCBvbmUgYXMgaW5hY3RpdmVcclxuICAgICAgXHJcbiAgICAgIHJldHVybiBjcmVkZW50aWFsSWQ7IC8vIFdvdWxkIHJldHVybiBuZXcgY3JlZGVudGlhbCBJRCBpbiBmdWxsIGltcGxlbWVudGF0aW9uXHJcbiAgICAgIFxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgbG9nZ2VyLmVycm9yKCfinYwgRmFpbGVkIHRvIHJvdGF0ZSBjcmVkZW50aWFsOicsIGVycm9yKTtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDcmVkZW50aWFsIHJvdGF0aW9uIGZhaWxlZCcpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2VuZXJhdGUgdW5pcXVlIGNyZWRlbnRpYWwgSURcclxuICAgKiBDcmVhdGVzIGlkZW50aWZpZXIgZm9yIGNyZWRlbnRpYWwgc3RvcmFnZVxyXG4gICAqIFxyXG4gICAqIEBwYXJhbSBzZXJ2aWNlIC0gU2VydmljZSBuYW1lXHJcbiAgICogQHBhcmFtIHR5cGUgLSBDcmVkZW50aWFsIHR5cGVcclxuICAgKiBAcmV0dXJucyBzdHJpbmcgVW5pcXVlIGNyZWRlbnRpYWwgSURcclxuICAgKi9cclxuICBwcml2YXRlIGdlbmVyYXRlQ3JlZGVudGlhbElkKHNlcnZpY2U6IHN0cmluZywgdHlwZTogQ3JlZGVudGlhbFR5cGUpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKS50b1N0cmluZygzNik7XHJcbiAgICBjb25zdCByYW5kb20gPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoMik7XHJcbiAgICByZXR1cm4gYCR7c2VydmljZX1fJHt0eXBlfV8ke3RpbWVzdGFtcH1fJHtyYW5kb219YDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFBlcnNpc3QgY3JlZGVudGlhbCB0byBzZWN1cmUgc3RvcmFnZVxyXG4gICAqIFN0b3JlcyBjcmVkZW50aWFsIGVudHJ5IHNlY3VyZWx5XHJcbiAgICogXHJcbiAgICogQHBhcmFtIGNyZWRlbnRpYWxFbnRyeSAtIENyZWRlbnRpYWwgZW50cnkgdG8gc3RvcmVcclxuICAgKi9cclxuICBwcml2YXRlIGFzeW5jIHBlcnNpc3RDcmVkZW50aWFsKGNyZWRlbnRpYWxFbnRyeTogQ3JlZGVudGlhbEVudHJ5KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAvLyBJbXBsZW1lbnRhdGlvbiB3b3VsZCBzdG9yZSBpbiBzZWN1cmUgZGF0YWJhc2VcclxuICAgIC8vIEZvciBub3csIHRoaXMgaXMgYSBwbGFjZWhvbGRlclxyXG4gICAgbG9nZ2VyLmRlYnVnKCdDcmVkZW50aWFsIHBlcnNpc3RlZCB0byBzZWN1cmUgc3RvcmFnZScsIHtcclxuICAgICAgY3JlZGVudGlhbElkOiBjcmVkZW50aWFsRW50cnkuY3JlZGVudGlhbElkXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExvYWQgY3JlZGVudGlhbCBmcm9tIHNlY3VyZSBzdG9yYWdlXHJcbiAgICogUmV0cmlldmVzIGNyZWRlbnRpYWwgZW50cnkgZnJvbSBzdG9yYWdlXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGNyZWRlbnRpYWxJZCAtIENyZWRlbnRpYWwgaWRlbnRpZmllclxyXG4gICAqIEByZXR1cm5zIFByb21pc2U8Q3JlZGVudGlhbEVudHJ5IHwgbnVsbD4gQ3JlZGVudGlhbCBlbnRyeSBvciBudWxsXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhc3luYyBsb2FkQ3JlZGVudGlhbChjcmVkZW50aWFsSWQ6IHN0cmluZyk6IFByb21pc2U8Q3JlZGVudGlhbEVudHJ5IHwgbnVsbD4ge1xyXG4gICAgLy8gSW1wbGVtZW50YXRpb24gd291bGQgbG9hZCBmcm9tIHNlY3VyZSBkYXRhYmFzZVxyXG4gICAgLy8gRm9yIG5vdywgdGhpcyBpcyBhIHBsYWNlaG9sZGVyXHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZSBjcmVkZW50aWFsIGluIHN0b3JhZ2VcclxuICAgKiBVcGRhdGVzIGNyZWRlbnRpYWwgZW50cnkgaW4gc2VjdXJlIHN0b3JhZ2VcclxuICAgKiBcclxuICAgKiBAcGFyYW0gY3JlZGVudGlhbEVudHJ5IC0gVXBkYXRlZCBjcmVkZW50aWFsIGVudHJ5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhc3luYyB1cGRhdGVDcmVkZW50aWFsKGNyZWRlbnRpYWxFbnRyeTogQ3JlZGVudGlhbEVudHJ5KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAvLyBJbXBsZW1lbnRhdGlvbiB3b3VsZCB1cGRhdGUgaW4gc2VjdXJlIGRhdGFiYXNlXHJcbiAgICAvLyBGb3Igbm93LCB0aGlzIGlzIGEgcGxhY2Vob2xkZXJcclxuICAgIGxvZ2dlci5kZWJ1ZygnQ3JlZGVudGlhbCB1cGRhdGVkIGluIHNlY3VyZSBzdG9yYWdlJywge1xyXG4gICAgICBjcmVkZW50aWFsSWQ6IGNyZWRlbnRpYWxFbnRyeS5jcmVkZW50aWFsSWRcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3RhcnQgY2FjaGUgY2xlYW51cCBwcm9jZXNzXHJcbiAgICogUmVtb3ZlcyBleHBpcmVkIGVudHJpZXMgZnJvbSBjcmVkZW50aWFsIGNhY2hlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGFydENhY2hlQ2xlYW51cCgpOiB2b2lkIHtcclxuICAgIHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdGhpcy5jcmVkZW50aWFsQ2FjaGUuZW50cmllcygpKSB7XHJcbiAgICAgICAgaWYgKHZhbHVlLmV4cGlyZXNBdCA8PSBub3cpIHtcclxuICAgICAgICAgIHRoaXMuY3JlZGVudGlhbENhY2hlLmRlbGV0ZShrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSwgNjAwMDApOyAvLyBDbGVhbiB1cCBldmVyeSBtaW51dGVcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBjcmVkZW50aWFsIG1hbmFnZXIgc3RhdHVzXHJcbiAgICogUmV0dXJucyBjdXJyZW50IHN0YXR1cyBmb3IgbW9uaXRvcmluZ1xyXG4gICAqIFxyXG4gICAqIEByZXR1cm5zIE9iamVjdCBjb250YWluaW5nIHN0YXR1cyBpbmZvcm1hdGlvblxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRTdGF0dXMoKToge1xyXG4gICAgY2FjaGVTaXplOiBudW1iZXI7XHJcbiAgICB0aW1lc3RhbXA6IG51bWJlcjtcclxuICB9IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGNhY2hlU2l6ZTogdGhpcy5jcmVkZW50aWFsQ2FjaGUuc2l6ZSxcclxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXHJcbiAgICB9O1xyXG4gIH1cclxufVxyXG5cclxuLy8gQ3JlYXRlIGFuZCBleHBvcnQgc2luZ2xldG9uIGluc3RhbmNlXHJcbmV4cG9ydCBjb25zdCBjcmVkZW50aWFsTWFuYWdlciA9IG5ldyBDcmVkZW50aWFsTWFuYWdlcigpO1xyXG5cclxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuLy8gQ1JFREVOVElBTCBTRUNVUklUWSBOT1RFU1xyXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4vLyAxLiBBbGwgY3JlZGVudGlhbHMgYXJlIGVuY3J5cHRlZCBiZWZvcmUgc3RvcmFnZVxyXG4vLyAyLiBDcmVkZW50aWFscyBhcmUgY2FjaGVkIHRlbXBvcmFyaWx5IGZvciBwZXJmb3JtYW5jZVxyXG4vLyAzLiBBbGwgY3JlZGVudGlhbCBhY2Nlc3MgaXMgbG9nZ2VkIGFuZCBhdWRpdGVkXHJcbi8vIDQuIEV4cGlyZWQgY3JlZGVudGlhbHMgYXJlIGF1dG9tYXRpY2FsbHkgcmVqZWN0ZWRcclxuLy8gNS4gQ3JlZGVudGlhbCByb3RhdGlvbiBpbnZhbGlkYXRlcyBvbGQgY3JlZGVudGlhbHNcclxuLy8gNi4gQ2FjaGUgaXMgYXV0b21hdGljYWxseSBjbGVhbmVkIG9mIGV4cGlyZWQgZW50cmllc1xyXG4vLyA3LiBOZXZlciBsb2cgYWN0dWFsIGNyZWRlbnRpYWwgdmFsdWVzXHJcbi8vIDguIFVzZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgZm9yIGluaXRpYWwgY3JlZGVudGlhbCBsb2FkaW5nXHJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Il0sInZlcnNpb24iOjN9